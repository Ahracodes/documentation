===============================
Upgrading studio customizations
===============================

TODOUPG should we publish upgrading studio customizations even though it will always be handled
by Odoo ? Given the time it takes some customers would be very happy to be able to fix it
themselves, especially since it can be fixed in the custom module mig script

.. _reference/upgrade/studio_views:

Studio views
------------

The upgrade process archives Odoo Studio view customizations if an issue is detected with their
definition. The logs will display a warning, but the upgrade process will not halt.

Unarchiving the view after the upgrade will trigger any error detected in Xpath targets (the `expr`
attribute) and show the complete error message, allowing you to find the broken Xpath expression. It
is recommended to open Odoo Studio on the unarchived view to ensure the view is working properly.

Views can also be deleted from the database during the upgrade if their corresponding model becomes
invalid, which can happen when models are deleted or changed. Deleted views cannot be restored after
the standard upgrade process, but their deletion can be prevented by `requesting assistance from a
developer of the Upgrade team <https://www.odoo.com/help>`_.

.. note::
   Custom views generated by Studio do not always contain immutable targets in their Xpath
   definition. When developing custom views with Studio, changing the generated Xpath to improve
   their robustness is a good practice.

.. spoiler:: The custom view <name> caused validation issues

   This warning is raised when a custom view created with Studio is not valid anymore due to Xpath
   targets that cannot be found in the parent view.

    .. example::

       .. code-block:: console

          2023-09-04 15:04:33,686 28 INFO database odoo.addons.base.models.ir_ui_view: Element '<xpath expr="//group[field[@name='activity_summary']]">' cannot be located in parent view

          View name: Odoo Studio: crm.lead.tree.opportunity customization
          Error context:
          view: ir.ui.view(1137,)
          xmlid: studio_customization.odoo_studio_crm_lead_378fc723-a146-2f5b-b6a7-a2f7e15922f8
          view.model: crm.lead
          view.parent: ir.ui.view(902,)

          2023-09-04 15:04:34,315 28 WARNING db_1146520 odoo.addons.base.maintenance.migrations.base.pre-models-ir_ui_view: The custom view `Odoo Studio: crm.lead.tree.opportunity customization` (ID: 1137, Inherit: 902, Model: crm.lead) caused validation issues.
          Disabling it for the migration ...

   This issue can be fixed by changing the Xpath target (the `expr` attribute) with a
   :ref:`migration script <upgrade/migration-scripts>` using the `edit_view` method from
   the `upgrade-util package <https://github.com/odoo/upgrade-util/>`_ to match the same element in
   the new version of the view.

.. seealso::
    - :ref:`reference/exceptions`
    - :doc:`/developer/reference/user_interface/view_records`
    - :ref:`Inheritance <tutorials/getting_started/13_inheritance>`

Studio fields
-------------

In case of invalid references on a field created by Studio, such as the `model`, `related`, or
`relation`, the field will be deleted by the standard upgrade process. It will, therefore, not be
accessible for the custom migration scripts or on the upgraded database.

This is why it is necessary to thoroughly test an upgraded database since lost data will **not** be
recoverable once the upgrade of the production database is completed.

.. example::
   In the upgrade from Odoo 12 to Odoo 13, the `account.invoice` model was merged with
   `account.move` and was then subsequently removed. The standard migration scripts took care of
   moving the standard data from the PSQL table `account_invoice` to `account_move` (such as the
   columns `partner_id`, `name`, `amount_residual`, etc.). Custom field created by users were not
   automatically moved. Once the data migration to `account_move` was completed, the
   `account_invoice` table was dropped, with all the custom data still in it.

In those situations, you can `request assistance from Odoo <https://www.odoo.com/help>`_ to upgrade
your custom fields during the standard upgrade process by specifying the following:

- The name of the field(s) removed from your database
- The name of the model(s) they were on
- The reason why they were removed (model removed, relation removed, related field removed, etc.)
- Which new model, relation, or related field they should be on
- Any additional information that could help retrieve the fields

Studio reports
--------------

The mechanism behind reports customization generated by Studio is the same as the one used for
:ref:`reference/upgrade/studio_views`.

For custom reports duplicated from a standard one, the upgrade process will not upgrade the copy,
meaning that it might be incompatible with the new version of Odoo. This can be fixed by re-copying
the content of the upgraded report and writing it over the content of the duplicated report. Note
that this might lead to issues with the Studio customizations made on the duplicate, such as
invalid Xpath targets.

.. important::
   The code of a duplicated report should not be modified to ensure it is upgradable. If you need
   to modify the code of a report, it is recommended to customize it with Studio.